# ネーム制作ツール - プロジェクト状況ファイル（リサイズ修復失敗版）

## 基本情報
- **プロジェクト名**: React製ネーム制作支援ツール
- **技術スタック**: React + TypeScript + HTML5 Canvas + jsPDF + html2canvas
- **開発開始**: 2025年9月8日
- **最終更新**: 2025年9月10日（リサイズ修復試行失敗）
- **現在の状況**: リサイズ機能修復失敗、コード分割も検討が必要

## 🚨 **現在発生中の問題**

### **リサイズ機能完全停止**（未解決）
- **症状**: 吹き出しとキャラクターのリサイズが一切動作しない
- **発生タイミング**: ファイル分割作業後
- **元々の状態**: Phase 8完了時点では正常動作していた
- **修復試行結果**: 全コード提供したが動作せず

### **新たな問題: コードサイズ過大**
- **CharacterRenderer.tsx**: 800行超の巨大ファイル
- **BubbleRenderer.tsx**: 300行超
- **CanvasComponent.tsx**: 600行超
- **状況**: ファイルサイズ制限により効率的な修正が困難

### **技術的詳細**
```
ログ出力（推定）:
🖱️ マウス移動イベント発生
❌ 移動処理スキップ: {isDragging: false, isResizing: false, isBubbleResizing: false}
```

**根本原因**: 
- `isBubbleResizing` フラグが `true` にならない
- `isCharacterResizing` フラグが `true` にならない
- リサイズハンドルクリック判定が失敗している

## 現在の実装状況

### ✅ 正常動作中の機能

#### 基本Canvas描画
- パネル、キャラクター、吹き出しの表示
- ダークモード対応の描画システム

#### スナップ設定UI機能
- **✅ スナップON/OFF**: ワンクリックで有効/無効切り替え
- **📐 グリッドサイズ選択**: 10px / 20px / 40px から選択可能
- **⚙️ スナップ感度調整**: 弱(6px) / 中(12px) / 強(20px) の3段階
- **👁️ グリッド表示設定**: 常時表示 / 編集時のみ / 非表示
- **🎯 リアルタイム反映**: 設定変更が即座にキャンバスに反映
- **📊 状態表示**: 現在のスナップ設定を右上に表示

#### コマ操作機能
- **コマ編集モード**: Ctrl+E または画面上部ボタンで切り替え
- **コマ移動**: 青い円形ハンドル（中央）をドラッグ
- **カスタマイズ可能スナップ機能**: ユーザー設定に基づく自動位置合わせ
- **補助線表示**: 移動中に破線ガイド表示（設定可能）
- **設定可能グリッド表示**: サイズ・表示タイミングをカスタマイズ
- **コマリサイズ**: 8方向ハンドル
- **コマ分割**: 紫のハサミボタン（右下角）
- **コマ削除**: 複数の削除方法
- **コマ複製**: 右クリック「📋 コマ複製」でパネル内要素も一緒に複製

#### パネルテンプレート自動配置
- **6種類のテンプレート**に専用シーン自動配置
- **自動配置要素**: キャラクター・吹き出し・斜め方向機能活用

#### 要素移動機能（正常動作）
- **吹き出し移動**: 自由移動（パネル外移動可能）
- **キャラクター移動**: 絶対座標での自由移動
- **ダブルクリック編集**: 吹き出しテキスト編集
- **右クリックメニュー**: 全機能正常動作

#### コピー&ペースト機能
- **Ctrl+C**: 選択中の要素（コマ・キャラ・吹き出し）をコピー
- **Ctrl+V**: コピーした要素をペースト
- **右クリックメニュー**: 「📋 コピー」「📌 ペースト」ボタン
- **クリップボード表示**: 右上にコピー中の要素を表示
- **Delete/Backspace**: 選択中の要素を削除
- **Escape**: 選択解除

#### エクスポート機能
- **PDF出力**: ネーム用レイアウト（A4サイズ自動調整）
- **PNG画像出力**: 高画質画像ファイル
- **PSD（クリスタ用）出力**: レイヤー構造付きデータ

#### その他機能
- **反転機能**: 水平反転・垂直反転（編集モード時のみ）
- **アンドゥ/リドゥ機能**: 操作履歴管理
- **キーボードショートカット対応**: 各種ショートカット
- **UI機能**: ダークモード・サイドバーレイアウト

### 🚨 **動作不良の機能**

#### リサイズ機能（完全停止）
- **❌ 吹き出しリサイズ**: 8方向ハンドル表示されるがクリック無効
- **❌ キャラクターリサイズ**: 8方向ハンドル表示されるがクリック無効
- **原因**: マウスダウン時にリサイズモードフラグが設定されない
- **修復試行**: 全コード提供も動作せず

### 🎉 Phase 8で完了していた項目（現在バグ発生）
1. ✅ **スナップ設定UI実装**: グリッドサイズ・感度・表示設定の完全カスタマイズ
2. ✅ **PanelManager分割**: パネル操作ロジックを独立モジュール化（350行分離）
3. ✅ **ContextMenuHandler分割**: 右クリックメニュー処理を独立モジュール化（250行分離）
4. ✅ **型定義拡張**: SnapSettings型の追加とCanvasComponentProps更新
5. ✅ **設定連携システム**: App.tsx → CanvasComponent.tsx → PanelManager.ts の完全な設定伝達
6. ✅ **コードベース最適化**: CanvasComponent.tsx を1000行 → 600行に削減（40%削減）
7. **❌ リサイズ機能**: 分割作業中に破損、修復失敗

## 🔧 **必要な作業**

### **Phase 8.1: リサイズ機能緊急修復** 🚨
**最優先**: 元々動作していたリサイズ機能の復旧

#### 修復方針の見直し:
1. **段階的修復**: 全コード置換ではなく、ピンポイント修正
2. **コード分割**: 巨大ファイルの分割を先行実施
3. **最小限修正**: 動作する最低限の修正に絞る

#### 推奨コード分割構成:
1. **CharacterRenderer.tsx分割案**:
   ```
   CharacterRenderer.tsx (基本描画・150行)
   CharacterFaceRenderer.tsx (顔描画・200行)
   CharacterBodyRenderer.tsx (体描画・250行)
   CharacterHandleRenderer.tsx (リサイズハンドル・100行)
   CharacterUtils.tsx (ユーティリティ・100行)
   ```

2. **BubbleRenderer.tsx分割案**:
   ```
   BubbleRenderer.tsx (基本描画・100行)
   BubbleShapeRenderer.tsx (形状描画・100行)
   BubbleHandleRenderer.tsx (リサイズハンドル・100行)
   ```

3. **CanvasComponent.tsx分割案**:
   ```
   CanvasComponent.tsx (メイン・300行)
   CanvasEventHandlers.tsx (イベント処理・200行)
   CanvasStateManager.tsx (状態管理・100行)
   ```

#### 修復の技術的要件:
- **8方向リサイズ**: nw, n, ne, e, se, s, sw, w の全方向対応
- **最小サイズ制限**: 吹き出し60x40px、キャラクター0.5倍スケール
- **最大サイズ制限**: キャラクター5.0倍スケール
- **リアルタイム反映**: ドラッグ中の即座サイズ変更

## 🏗️ ファイル構造（現在）
```
src/
├── types.ts                    # 共通型定義（SnapSettings追加）
├── App.tsx                     # メインアプリ（スナップ設定UI付き）
├── components/
│   ├── CanvasComponent.tsx     # Canvas操作中核（600行、リサイズバグあり）
│   ├── UI/
│   │   ├── CharacterDetailPanel.tsx # キャラクター詳細設定
│   │   └── ExportPanel.tsx          # エクスポートUI
│   └── CanvasArea/
│       ├── PanelManager.ts          # パネル操作ロジック（350行）
│       ├── ContextMenuHandler.ts    # 右クリックメニュー処理（250行）
│       ├── CanvasDrawing.ts         # Canvas描画処理
│       ├── EditBubbleModal.tsx      # 編集モーダル
│       ├── templates.ts             # パネルテンプレート定義
│       ├── sceneTemplates.ts        # シーンテンプレート定義
│       └── renderers/
│           ├── BubbleRenderer.tsx    # 吹き出し描画・操作（300行、リサイズバグあり）
│           ├── CharacterRenderer.tsx # キャラクター描画・操作（800行、リサイズバグあり）
│           └── PanelRenderer.tsx     # パネル描画・操作
├── services/
│   └── ExportService.ts        # エクスポート機能中核
```

## 🎯 **推奨次期作業方針**

### **Phase 8.2: コード分割優先実施** 🔜 **最優先**
1. **CharacterRenderer.tsx分割**: 800行を5ファイルに分割
2. **BubbleRenderer.tsx分割**: 300行を3ファイルに分割
3. **CanvasComponent.tsx分割**: 600行を3ファイルに分割

### **Phase 8.3: リサイズ機能段階的修復** 🔜 **分割後実施**
1. **最小限のリサイズハンドル修復**: クリック判定のみ
2. **段階的機能回復**: 移動→リサイズ→完全機能
3. **動作確認**: 各段階で動作テスト

### **Phase 9: 次世代機能** 🔜
- ズーム機能、ルーラー機能、残コード分割完了

**現在の進捗率: 90% 完了（リサイズ機能停止とコード分割必要により10%減）** 🚧

## 🎯 対応方針

### **短期目標（1-2日以内）**
1. **🔄 コード分割実施**: 大きなファイルを分割して管理可能にする
2. **🔍 段階的デバッグ**: ピンポイントでリサイズ機能を修復

### **中期目標（1週間）**
1. **🔧 リサイズ機能完全復旧**: 8方向リサイズの完全実装
2. **🧪 全機能テスト**: 修復後の動作確認

### **長期目標（1ヶ月）**
1. **🎨 背景・小物システム実装**: 効果線・集中線の追加
2. **🤖 ChatGPT API連携**: AIによるストーリー相談機能

## 📝 **開発者メモ**

### **疲労度**: 非常に高 😵
### **問題の性質**: 既存機能の破損（新機能開発ではない）
### **緊急度**: 最高（基本機能に影響）
### **修復見積もり**: 3-5時間の集中作業（分割作業含む）

**次回作業時の優先順位:**
1. **最優先**: コード分割の実施
2. **次点**: 分割後のリサイズ機能修復
3. **最後**: 新機能追加

**重要**: まちまちなコード提供ではなく、段階的で管理可能な修復アプローチが必要

### **反省点**
- 一度に大量のコード提供は非効率
- ファイルサイズ制限を考慮した設計が不足
- 段階的な修復アプローチが必要だった