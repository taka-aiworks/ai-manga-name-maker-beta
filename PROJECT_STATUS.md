# ネーム制作ツール - プロジェクト状況ファイル（v1.1.3用紙サイズ機能実装版）

## 🎯 **現在の状況: v1.1.3 用紙サイズ機能実装版** 🚀

- **プロジェクト名**: React製ネーム制作支援ツール
- **技術スタック**: React + TypeScript + HTML5 Canvas + jsPDF + html2canvas
- **最終更新**: 2025年9月23日 - v1.1.3 用紙サイズ機能実装版
- **完成度**: **基本機能完成・要素連動調整が必要** 📐

---

## 🚨 **現在の緊急問題（2025年9月23日発生）**

### **🔧 パネル操作不能問題**
- **現象**: 動的スケール機能実装後、パネルのクリック・選択・操作ができなくなる
- **原因**: TemplateScaler.ts導入による座標計算の副作用でマウスイベント処理が破綻
- **影響**: 基本的なパネル編集機能が使用不能
- **緊急度**: **最高**（コア機能停止）

### **🖼️ テンプレートプレビュー巨大化問題**
- **現象**: パネルテンプレート選択UIのプレビューが画面からはみ出るサイズになる
- **原因**: templates.tsの座標を4倍にスケールした影響がプレビュー描画にも適用
- **影響**: テンプレート選択UIが実用不能
- **関連ファイル**: PanelTemplateSelector.tsx

### **🔄 無限ループ・重複実行問題**
- **現象**: 用紙サイズ変更時やテンプレート選択時に処理が重複実行される
- **原因**: useEffect依存関係の競合とScaleTransformUtilsとTemplateScalerの機能重複
- **影響**: パフォーマンス低下・予期しない動作
- **症状**: パネル選択がロックされる、座標がずれる

---

## 🆕 **v1.1.3 用紙サイズ機能実装アップデート（2025年9月23日）**

### **🚀 v1.1.3 で新たに実装した機能**
- **✅ 用紙サイズ選択パネル**: A4/B5/A4横/Twitter/カスタムサイズ対応
- **✅ カスタムサイズ機能**: 幅・高さの任意設定とプリセットボタン
- **✅ キャンバス動的リサイズ**: 用紙サイズ変更時の物理的キャンバスサイズ連動
- **✅ 設定保存・復元**: プロジェクト保存時に用紙サイズ設定も保持
- **✅ 解像度設定整理**: 重複していた解像度設定を出力パネルに一本化
- **⚠️ 動的スケール機能**: ScaleTransformUtils.ts + TemplateScaler.tsによる座標変換（問題発生中）

### **🎯 v1.1.3 で実現した価値**
- **用紙サイズの実用性**: AI漫画制作での最適なアスペクト比設定
- **印刷・投稿対応**: 同人誌（B5）からSNS投稿（Twitter）まで対応
- **カスタム自由度**: 任意サイズ設定による完全なカスタマイズ性
- **ワークフロー統一**: ネーム制作→AI生成→出力の一貫したサイズ管理

### **🔧 v1.1.3 新規追加ファイル**
1. **PaperSizeSelectPanel.tsx**: 用紙サイズ選択UI（完全新規・約300行）
2. **🚨 ScaleTransformUtils.ts**: スケール変換ユーティリティ（問題の原因）
3. **🚨 TemplateScaler.ts**: 動的テンプレート生成（問題の原因）

### **🔧 v1.1.3 修正ファイル**
1. **types.ts**: 用紙サイズ関連型定義追加（PaperSize, CanvasSettings, PAPER_SIZES等）
2. **App.tsx**: 用紙サイズ状態管理とキャンバスリサイズ処理追加
3. **useProjectSave.ts**: 用紙サイズ設定の保存・読み込み対応
4. **🚨 templates.ts**: 座標を4倍スケール（プレビュー問題の原因）

### **📊 v1.1.3 実装結果**
```
=== 用紙サイズ機能の動作確認 ===
【実装完了】
✅ 用紙サイズ選択UI表示
✅ カスタムサイズ入力・適用
✅ キャンバス物理サイズ変更
✅ 設定保存・読み込み
✅ 解像度設定重複解消

【重大な問題発生】
🚨 パネル操作不能（マウスイベント破綻）
🚨 テンプレートプレビュー巨大化
🚨 座標計算の競合・重複実行
🚨 基本UI操作の安定性低下

【現在の課題】
⚠️ コマ（パネル）のサイズ連動未実装
⚠️ 既存要素の座標・サイズ変換未実装
⚠️ 表示倍率最適化が必要
```

### **🚧 緊急修正が必要な技術的課題**

#### **1. 基本操作機能復旧**
- **最優先**: パネル選択・移動・リサイズ機能の復旧
- **必要作業**: 
  - TemplateScaler.ts機能の無効化または削除
  - App.tsx内の動的スケール処理の削除
  - handleTemplateClick関数の単純版への復旧
  - templates.ts座標の元サイズへの復旧
- **期待結果**: 基本的なパネル操作が正常に動作

#### **2. プレビューUI修復**
- **問題**: PanelTemplateSelectorのプレビューが画面外サイズ
- **解決案**: プレビュー専用のスケール処理追加、または座標正規化
- **影響範囲**: PanelTemplateSelector.tsx

#### **3. 座標系統一**
- **根本原因**: ScaleTransformUtilsとTemplateScalerの機能重複
- **解決方針**: 単一の座標変換システムに統一
- **実装方法**: 既存のScaleTransformUtilsのみ使用、TemplateScalerは削除

---

## 🛠️ **緊急修正計画**

### **Phase 1: 基本機能復旧（最優先）**
1. **App.tsx**: 動的スケール関連コード削除
2. **templates.ts**: 座標を元の値（x:20, width:560等）に復旧
3. **TemplateScaler.ts**: ファイル削除またはimport削除
4. **handleTemplateClick**: シンプル版に戻す

### **Phase 2: プレビュー修復**
1. **PanelTemplateSelector.tsx**: プレビュー描画のスケール調整
2. **templates.ts**: プレビュー用とキャンバス用の座標分離

### **Phase 3: 用紙サイズ機能再実装（後日）**
1. **ScaleTransformUtils**: 既存要素変換のみに特化
2. **templates.ts**: 固定座標+実行時スケール方式
3. **安定性確保**: 段階的実装・十分なテスト

---

## 🆕 **v1.1.2 統一ファクトリーシステム完全実装版アップデート** 【継続】

### **🚀 v1.1.2 で完全実装した革命的システム**
- **✅ 統一要素ファクトリーシステム**: 全要素（キャラ・吹き出し・背景・効果線・トーン）を統一API化
- **✅ テンプレート吹き出し編集問題完全解決**: 手動作成とテンプレート作成の完全な互換性確保
- **✅ 座標系統一**: `isGlobalPosition`による統一座標管理システム
- **✅ シーンテンプレート60%コード削減**: 800行→300行の劇的簡素化
- **✅ プリセットシステム**: 感情・行動・用途別の最適化されたプリセット群

---

## ✅ **v1.1.1 最終完成版アップデート** 【継続】

### **🔧 v1.1.1 で完全解決した全問題**
- **✅ デフォルト値プロンプト出力問題完全解決**: 未選択時は一切出力されない
- **✅ キャラクター配置パネル判定問題完全解決**: リアルタイム座標ベース判定
- **✅ キャラクター初期値問題完全解決**: 全詳細設定が未選択でスタート
- **✅ 移動後プロンプト更新問題完全解決**: 座標変更が即座に反映

---

## ✅ **v1.1.0～v1.0.2までの完了済み全機能（継続）**

### **コア機能**
- **Canvas描画システム**: パネル・キャラクター・吹き出し・背景・トーン・効果線 ✅
- **要素ラベル表示**: 背景・効果線・トーンの日本語ラベル表示 ✅
- **8方向リサイズ**: 全要素完全対応 ✅
- **スナップ・グリッド機能**: パネル境界スナップ・完全動作 ✅
- **🚨 コマ操作**: 移動・分割・削除・複製・**現在動作不能**
- **コピー&ペースト**: 全要素対応・完全動作 ✅

### **高機能システム**
- **🆕 用紙サイズ選択システム**: A4/B5/カスタムサイズ対応・キャンバス連動 ✅
- **🆕 統一ファクトリーシステム**: 全要素の統一API・プリセットライブラリ ✅
- **🆕 テンプレート編集互換性**: 手動作成とテンプレート作成の完全互換 ✅
- **🆕 基本プロンプト設定**: CharacterSettingsPanelでの入力・保存・出力完全対応 ✅
- **🆕 詳細設定統合**: 基本プロンプト + 詳細設定の統合出力 ✅
- **🆕 未選択時完全除外**: 未選択項目は一切プロンプトに出力されない ✅
- **🆕 座標ベースパネル判定**: キャラクター移動後もリアルタイム反映 ✅
- **プロンプト出力**: AI画像生成用プロンプト自動生成（基本+詳細設定対応）✅
- **プロンプトメーカー連携**: ベースプロンプト貼り付け・統合出力 ✅
- **詳細設定システム**: 辞書ベース検索選択・6項目対応 ✅
- **シーンテンプレート**: 17種類・ワンクリック適用・一括配置・60%コード削減 ✅
- **🚨 パネルテンプレート**: 21種類・コマ数別分類・**プレビュー表示問題**
- **キャラクター名前管理**: 動的名前表示・完全カスタマイズ ✅
- **ページ管理システム**: 複数ページ対応・完全操作 ✅

### **エクスポート・UI**
- **エクスポート**: PDF/PNG/PSD出力・レイヤー分離対応 ✅
- **背景機能**: テンプレート対応・ラベル表示 ✅
- **効果線機能**: 5種類・完全描画・Canvas統合 ✅
- **トーン機能**: 8種類・Canvas統合・ラベル表示 ✅
- **ダークモード**: 完全対応 ✅
- **キーボードショートカット**: 全機能対応 ✅
- **右クリックメニュー**: 全機能アクセス可能 ✅

---

## 📁 **現在のファイル構造（v1.1.3用紙サイズ機能実装版）**

```
src/
├── App.tsx                            # メインアプリケーション（用紙サイズ対応版）⚠️
├── types.ts                           # 型定義（v1.1.3用紙サイズ型追加版）✅
├── App.css                            # メインCSS
├── index.tsx                          # エントリーポイント
├── components/
│   ├── CanvasComponent.tsx            # Canvas統合コンポーネント ✅
│   ├── CanvasComponent/               # Canvas描画フック群
│   │   └── hooks/
│   │       ├── useCanvasDrawing.ts    # Canvas描画制御 ✅
│   │       ├── useCanvasState.ts      # Canvas状態管理 ✅
│   │       ├── useElementActions.ts   # 要素操作 ✅
│   │       ├── useKeyboardEvents.ts   # キーボードイベント ✅
│   │       └── useMouseEvents.ts      # マウスイベント ⚠️
│   ├── UI/                           # ユーザーインターフェース
│   │   ├── PageManager.tsx           # ページ管理UI ✅
│   │   ├── CharacterDetailPanel.tsx  # 詳細設定UI ✅
│   │   ├── CharacterSettingsPanel.tsx # 基本プロンプト設定UI ✅
│   │   ├── ExportPanel.tsx           # エクスポート機能 ✅
│   │   ├── 🆕 PaperSizeSelectPanel.tsx  # 用紙サイズ選択UI（v1.1.3新規）✅
│   │   ├── ProjectPanel.tsx          # プロジェクト管理UI ✅
│   │   ├── BackgroundPanel.tsx       # 背景設定UI ✅
│   │   ├── EffectPanel.tsx           # 効果線設定UI ✅
│   │   ├── TonePanel.tsx             # トーン設定UI ✅
│   │   ├── SceneTemplatePanel.tsx    # シーンテンプレートUI ✅
│   │   └── PanelTemplateSelector.tsx # パネルテンプレート選択UI 🚨
│   └── CanvasArea/                   # Canvas描画ロジック
│       ├── CanvasDrawing.ts          # 基本描画機能 ✅
│       ├── ContextMenuHandler.ts     # 右クリックメニュー ✅
│       ├── EditBubbleModal.tsx       # 吹き出し編集モーダル ✅
│       ├── MouseEventHandler.ts      # マウスイベント処理 ✅
│       ├── PanelManager.ts           # パネル管理 ✅
│       ├── templates.ts              # パネルテンプレート（21種類）🚨
│       ├── sceneTemplates.ts         # シーンテンプレート（統一ファクトリー版）✅
│       ├── backgroundTemplates.ts    # 背景テンプレート ✅
│       ├── effectTemplates.ts        # 効果線テンプレート ✅
│       ├── toneTemplates.ts          # トーンテンプレート ✅
│       └── renderers/                # 描画エンジン群
│           ├── BackgroundRenderer.tsx # 背景描画エンジン ✅
│           ├── BubbleRenderer.tsx    # 吹き出し描画エンジン ✅
│           ├── CharacterBodyRenderer.tsx # キャラクター体描画 ✅
│           ├── CharacterRenderer/    # キャラクター描画システム
│           │   ├── CharacterRenderer.tsx # メイン描画エンジン ✅
│           │   ├── CharacterRotation.ts  # 回転処理 ✅
│           │   ├── drawing/
│           │   │   └── CharacterHair.ts  # 髪描画 ✅
│           │   └── utils/
│           │       ├── CharacterBounds.ts # 境界計算 ✅
│           │       └── CharacterUtils.ts  # ユーティリティ ✅
│           ├── EffectRenderer.tsx     # 効果線描画 ✅
│           ├── ElementLabelRenderer.tsx # 要素ラベル描画 ✅
│           ├── PanelRenderer.tsx      # パネル描画 ✅
│           └── ToneRenderer.tsx       # トーン描画 ✅
├── hooks/                            # カスタムフック
│   ├── usePageManager.ts             # ページ管理フック ✅
│   └── useProjectSave.ts             # プロジェクト保存フック（用紙サイズ対応版）✅
├── services/                         # サービス層
│   ├── ExportService.ts              # エクスポート処理 ✅
│   ├── PromptService.ts              # プロンプト生成 ✅
│   └── SaveService.ts                # 保存処理 ✅
├── utils/                           # ユーティリティ
│   ├── elementFactory.ts             # 統一要素ファクトリーシステム ✅
│   ├── PanelFittingUtils.ts          # パネルフィット処理 ✅
│   ├── backgroundUtils.ts            # 背景ユーティリティ ✅
│   ├── ScaleTransformUtils.ts        # スケール変換ユーティリティ ✅
│   └── 🚨 TemplateScaler.ts            # 動的テンプレート生成（問題の原因）
└── [設定・その他ファイル]
    ├── react-app-env.d.ts           # React型定義
    ├── setupTests.ts                # テスト設定
    └── reportWebVitals.ts           # パフォーマンス測定
```

### **📊 ファイル数統計（v1.1.3）**
- **総ファイル数**: 約51ファイル（+3）
- **TypeScriptファイル**: 約40ファイル（+3）
- **🆕 v1.1.3新規追加ファイル**: 3ファイル（PaperSizeSelectPanel.tsx, ScaleTransformUtils.ts, TemplateScaler.ts）
- **🆕 v1.1.3修正ファイル**: 4ファイル（types.ts, App.tsx, useProjectSave.ts, templates.ts）
- **🚨 問題発生ファイル**: 3ファイル（App.tsx, templates.ts, TemplateScaler.ts）

---

## 🎯 **次期アップデート計画 v1.1.4**

### **緊急優先度: 基本機能復旧**
- **パネル操作機能復旧**: マウスイベント処理の正常化
- **テンプレートプレビュー修復**: UI表示の正常化
- **座標系統一**: 単一の変換システムに統合

### **優先度1: 要素サイズ連動システム実装（安定後）**
- **パネルサイズ自動調整**: 用紙サイズに比例したテンプレートパネルサイズ
- **既存要素座標変換**: 全要素の位置・サイズを新用紙サイズに変換
- **相対座標システム強化**: より正確な座標変換アルゴリズム

### **優先度2: 用紙サイズ機能拡張**
- **追加用紙サイズ**: A5, A3, B4, はがきサイズ等
- **印刷マージン表示**: セーフエリア・裁ち落とし表示
- **用紙方向自動判定**: 縦横比による最適表示

### **優先度3: エクスポート品質向上**
- **用紙サイズ連動PDF**: 正確な用紙サイズでのPDF出力
- **高解像度PNG**: DPI設定に基づく品質出力
- **印刷最適化**: CMYK対応・トンボ追加

---

## 🏆 **v1.1.3 達成事項**

### **🚀 世界初の価値（用紙サイズ対応版）**
- **ネーム制作×AI生成×用紙サイズの完全連携**システム実現
- **カスタム用紙サイズ対応**による無制限の自由度
- **投稿サイト最適化**（Twitter/pixiv等）の自動対応
- **印刷業界標準対応**（A4/B5等）による商用利用可能性
- **ワークフロー統一**によるネーム→AI生成→出力の一貫管理

### **🆕 v1.1.3 用紙サイズ版新価値**
- **サイズ別最適化**: 用途に応じた最適なアスペクト比選択
- **カスタム自由度**: 任意サイズ設定による完全カスタマイズ
- **設定永続化**: プロジェクト保存による用紙サイズ設定維持
- **UI統合**: 既存システムとの完全な統合
- **拡張性確保**: 将来的な用紙サイズ追加への対応

### **🏆 商用価値（v1.1.3版）**
- **基本機能完成**: 用紙サイズ選択・カスタムサイズ・設定保存が完全動作
- **🚨 実用性低下**: 基本操作不能により一時的に使用困難
- **差別化強化**: 他ツールにない詳細な用紙サイズ対応（修復後）
- **収益化準備**: 印刷・投稿両対応による幅広いユーザー層獲得（修復後）
- **技術的完成度**: 一時的に60%（基本機能復旧で90%回復予定）

---

## 🔧 **現在の技術的課題と解決方針**

### **🚨 緊急課題: 基本機能復旧**
```typescript
// 現在の問題
パネル操作: 完全に動作不能 🚨
テンプレートプレビュー: 巨大化で実用不能 🚨
座標計算: 競合・重複実行で不安定 🚨

// 即時解決方針
1. TemplateScaler.ts機能無効化
2. templates.ts座標を元に戻す
3. App.tsx動的スケール処理削除
4. handleTemplateClick関数単純化
```

### **課題1: コマサイズ連動問題（後日対応）**
```typescript
// 現在の問題
キャンバスサイズ: 変更される ✅
パネル（コマ）サイズ: 固定値のまま ❌

// 解決方針（安定化後）
ScaleTransformUtils.tsのみ使用した
安全な座標変換システム構築
```

### **課題2: 座標変換システム統一**
```typescript
// 必要な統一処理
- 単一の座標変換エンジン
- ScaleTransformUtilsに機能集約
- TemplateScalerの機能統合
- 段階的・安全な実装
```

### **課題3: プレビューシステム最適化**
```typescript
// 現状: 巨大化したプレビュー
// 必要: 表示用スケール処理
// 実装: プレビュー専用座標系
```

---

## 📋 **開発完了情報**

- **開発環境**: React + TypeScript + HTML5 Canvas
- **現在の状況**: v1.1.3用紙サイズ基本機能完成・緊急修復が必要
- **完成度**: 一時的に60%（基本機能復旧で90%回復予定）
- **技術負債**: 3件（パネル操作不能、プレビュー巨大化、座標系競合）・緊急解決が必要

---

## 🚨 **緊急対応宣言**

**v1.1.3で発生した重大な問題により、基本的なパネル操作が不能となりました。**

用紙サイズ機能の実装は成功しましたが、動的スケールシステムの副作用により、コアとなるパネル編集機能が使用できない状況です。緊急修復を優先し、安定性を回復した後に用紙サイズ機能の完全実装を再開します。

**開発チーム、緊急修復モードに移行・基本機能復旧を最優先で実施中！** 🚨