// src/components/CanvasArea/sceneTemplates.ts - types.tsÊ∫ñÊã†Áâà
import { Character, SpeechBubble, BackgroundElement, EffectElement, ToneElement } from "../../types";

export interface EnhancedSceneTemplate {
  name: string;
  description: string;
  category: 'emotion' | 'action' | 'daily';
  characters: Omit<Character, "id">[];
  speechBubbles: Omit<SpeechBubble, "id">[];
  backgrounds?: Omit<BackgroundElement, "id">[];
  effects?: Omit<EffectElement, "id">[];
  tones?: Omit<ToneElement, "id">[];
}

// üé≠ ÊÑüÊÉÖÁ≥ª„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„Éà
export const emotionSceneTemplates: Record<string, EnhancedSceneTemplate> = {
  // üò≤ È©ö„Åç„Éª„Ç∑„Éß„ÉÉ„ÇØÁ≥ª
  surprise_shock: {
    name: "üò≤ È©ö„Åç„Éª„Ç∑„Éß„ÉÉ„ÇØ",
    description: "Â§ß„Åç„ÅèÈ©ö„ÅÑ„ÅüÁû¨Èñì„ÅÆ„Ç∑„Éº„É≥",
    category: 'emotion',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 280,
        y: 120,
        scale: 2.5,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "surprised",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "„Åà„Å£ÔºÅÔºü",
        x: 150,
        y: 60,
        scale: 1.2,
        width: 80,
        height: 70,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "speed",
        x: 0.1,
        y: 0.1,
        width: 0.8,
        height: 0.8,
        direction: "radial",
        intensity: 0.8,
        density: 0.7,
        length: 30,
        angle: 0,
        color: "#333333",
        opacity: 0.6,
        blur: 0,
        selected: false,
        zIndex: 1,
        isGlobalPosition: false,
      },
    ],
    tones: [
      {
        panelId: 1,
        type: "dots",
        pattern: "dots_60",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 0.4,
        density: 0.5,
        opacity: 0.3,
        rotation: 0,
        scale: 1.0,
        blendMode: "multiply",
        contrast: 1.0,
        brightness: 0,
        invert: false,
        maskEnabled: false,
        maskShape: "rectangle",
        maskFeather: 0,
        selected: false,
        zIndex: 0,
        isGlobalPosition: false,
        visible: true,
      },
    ],
  },

  // üò¢ ÊÇ≤„Åó„Åø„ÉªÊ∂ôÁ≥ª
  sadness_tears: {
    name: "üò¢ ÊÇ≤„Åó„Åø„ÉªÊ∂ô",
    description: "ÊÇ≤„Åó„Åø„Å´ÊöÆ„Çå„ÇãÊÑüÊÉÖË°®Áèæ",
    category: 'emotion',
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 250,
        y: 120,
        scale: 2.3,
        facing: "front",
        gaze: "down",
        pose: "sitting",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "sad",
        bodyPose: "sitting",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÂøÉ„ÅÆÂ£∞",
        text: "„Å©„ÅÜ„Åó„Å¶...",
        x: 380,
        y: 60,
        scale: 1.0,
        width: 90,
        height: 70,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    backgrounds: [
      {
        panelId: 1,
        type: "gradient",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        rotation: 0,
        zIndex: -1,
        opacity: 0.4,
        gradientType: "linear",
        gradientColors: ["#cccccc", "#888888"],
        gradientDirection: 270,
      },
    ],
    tones: [
      {
        panelId: 1,
        type: "lines",
        pattern: "lines_diagonal",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        density: 0.4,
        opacity: 0.3,
        rotation: 45,
        scale: 1.0,
        blendMode: "multiply",
        contrast: 1.0,
        brightness: 0,
        invert: false,
        maskEnabled: false,
        maskShape: "rectangle",
        maskFeather: 0,
        selected: false,
        zIndex: 0,
        isGlobalPosition: false,
        visible: true,
      },
    ],
  },

  // üò° ÊÄí„Çä„ÉªÊøÄÊÉÖÁ≥ª
  anger_fury: {
    name: "üò° ÊÄí„Çä„ÉªÊøÄÊÉÖ",
    description: "ÊøÄ„Åó„ÅÑÊÄí„Çä„ÅÆË°®Áèæ",
    category: 'emotion',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 200,
        y: 130,
        scale: 2.2,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "angry",
        bodyPose: "arms_crossed",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "Ë®±„Åõ„Å™„ÅÑÔºÅ",
        x: 80,
        y: 60,
        scale: 1.3,
        width: 100,
        height: 80,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "explosion",
        x: 0.15,
        y: 0.15,
        width: 0.7,
        height: 0.7,
        direction: "radial",
        intensity: 0.9,
        density: 0.8,
        length: 25,
        angle: 0,
        color: "#ff4444",
        opacity: 0.8,
        blur: 1,
        selected: false,
        zIndex: 2,
        isGlobalPosition: false,
      },
    ],
    tones: [
      {
        panelId: 1,
        type: "dots",
        pattern: "dots_85",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        density: 0.6,
        opacity: 0.4,
        rotation: 0,
        scale: 1.2,
        blendMode: "multiply",
        contrast: 1.2,
        brightness: 0,
        invert: false,
        maskEnabled: false,
        maskShape: "rectangle",
        maskFeather: 0,
        selected: false,
        zIndex: 0,
        isGlobalPosition: false,
        visible: true,
      },
    ],
  },

  // üòÑ Âñú„Å≥„ÉªÂπ∏„ÅõÁ≥ª
  joy_happiness: {
    name: "üòÑ Âñú„Å≥„ÉªÂπ∏„Åõ",
    description: "Êòé„Çã„ÅèÊ•Ω„Åó„ÅÑÁû¨Èñì",
    category: 'emotion',
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 150,
        y: 120,
        scale: 2.0,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "smile",
        bodyPose: "waving",
      },
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 400,
        y: 120,
        scale: 2.0,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "smile",
        bodyPose: "pointing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„ÇÑ„Å£„Åü„Å≠ÔºÅ",
        x: 80,
        y: 70,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„ÅÜ„Çì‚ô™",
        x: 450,
        y: 65,
        scale: 1.0,
        width: 70,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    backgrounds: [
      {
        panelId: 1,
        type: "gradient",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        rotation: 0,
        zIndex: -1,
        opacity: 0.5,
        gradientType: "linear",
        gradientColors: ["#87CEEB", "#F0F8FF"],
        gradientDirection: 180,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "flash",
        x: 0.2,
        y: 0.2,
        width: 0.6,
        height: 0.6,
        direction: "radial",
        intensity: 0.7,
        density: 0.6,
        length: 20,
        angle: 0,
        color: "#ffdd44",
        opacity: 0.7,
        blur: 2,
        selected: false,
        zIndex: 1,
        isGlobalPosition: false,
      },
    ],
  },

  // üò≥ ÊÅ•„Åö„Åã„Åó„Åå„ÇäÁ≥ª
  embarrassed_shy: {
    name: "üò≥ ÊÅ•„Åö„Åã„Åó„Åå„Çä",
    description: "ÁÖß„Çå„Å¶„ÅÑ„ÇãÂèØÊÑõ„Çâ„Åó„ÅÑË°®ÊÉÖ",
    category: 'emotion',
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 280,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "down",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "rightFront",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "rightFront",
        faceExpression: "embarrassed",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Â∞èÂ£∞",
        text: "„ÅÇ„ÅÆ...",
        x: 150,
        y: 70,
        scale: 0.9,
        width: 60,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "flash",
        x: 0.35,
        y: 0.25,
        width: 0.3,
        height: 0.2,
        direction: "radial",
        intensity: 0.6,
        density: 0.5,
        length: 15,
        angle: 0,
        color: "#ff8888",
        opacity: 0.8,
        blur: 3,
        selected: false,
        zIndex: 1,
        isGlobalPosition: false,
      },
    ],
  },
};

// üöÄ „Ç¢„ÇØ„Ç∑„Éß„É≥Á≥ª„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„Éà
export const actionSceneTemplates: Record<string, EnhancedSceneTemplate> = {
  // üí® Ëµ∞„Çã„Éª„Çπ„Éî„Éº„ÉâÁ≥ª
  running_speed: {
    name: "üí® Ëµ∞„Çã„Éª„Çπ„Éî„Éº„Éâ",
    description: "ÁñæËµ∞ÊÑü„ÅÇ„Åµ„Çå„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥",
    category: 'action',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 200,
        y: 140,
        scale: 2.3,
        facing: "front",
        gaze: "right",
        pose: "running",
        expression: "neutral",
        viewType: "fullBody",
        faceAngle: "right",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "right",
        faceExpression: "normal",
        bodyPose: "running",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "ÊÄ•„ÅíÔºÅ",
        x: 80,
        y: 60,
        scale: 1.1,
        width: 70,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "speed",
        x: 0.0,
        y: 0.3,
        width: 0.6,
        height: 0.4,
        direction: "horizontal",
        intensity: 0.8,
        density: 0.9,
        length: 40,
        angle: 10,
        color: "#666666",
        opacity: 0.7,
        blur: 1,
        selected: false,
        zIndex: 1,
        isGlobalPosition: false,
      },
    ],
  },

  // ‚úä Êà¶Èóò„Éª„Éê„Éà„É´Á≥ª
  battle_fight: {
    name: "‚úä Êà¶Èóò„Éª„Éê„Éà„É´",
    description: "ÊøÄ„Åó„ÅÑÊà¶Èóò„Ç∑„Éº„É≥",
    category: 'action',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 150,
        y: 130,
        scale: 2.4,
        facing: "front",
        gaze: "right",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "right",
        eyeDirection: "right",
        isGlobalPosition: true,
        bodyDirection: "right",
        faceExpression: "angry",
        bodyPose: "pointing",
      },
      {
        panelId: 1,
        type: "rival",
        name: "„É©„Ç§„Éê„É´",
        x: 420,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "angry",
        bodyPose: "arms_crossed",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "Ë°å„Åè„ÅûÔºÅ",
        x: 70,
        y: 60,
        scale: 1.2,
        width: 80,
        height: 70,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "Êù•„ÅÑÔºÅ",
        x: 480,
        y: 65,
        scale: 1.1,
        width: 70,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "explosion",
        x: 0.3,
        y: 0.2,
        width: 0.4,
        height: 0.6,
        direction: "radial",
        intensity: 0.9,
        density: 0.8,
        length: 30,
        angle: 0,
        color: "#ff6666",
        opacity: 0.8,
        blur: 0,
        selected: false,
        zIndex: 2,
        isGlobalPosition: false,
      },
    ],
    tones: [
      {
        panelId: 1,
        type: "lines",
        pattern: "lines_vertical",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        density: 0.7,
        opacity: 0.4,
        rotation: 0,
        scale: 1.0,
        blendMode: "multiply",
        contrast: 1.1,
        brightness: 0,
        invert: false,
        maskEnabled: false,
        maskShape: "rectangle",
        maskFeather: 0,
        selected: false,
        zIndex: 0,
        isGlobalPosition: false,
        visible: true,
      },
    ],
  },

  // üí´ Ë°ùÊíÉ„Éª„Ç§„É≥„Éë„ÇØ„ÉàÁ≥ª
  shock_impact: {
    name: "üí´ Ë°ùÊíÉ„Éª„Ç§„É≥„Éë„ÇØ„Éà",
    description: "Âº∑ÁÉà„Å™Ë°ùÊíÉ„ÅÆÁû¨Èñì",
    category: 'action',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 280,
        y: 140,
        scale: 2.0,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "surprised",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "„ÅÜ„Çè„ÅÇÔºÅ",
        x: 150,
        y: 60,
        scale: 1.4,
        width: 90,
        height: 80,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "speed",
        x: 0.1,
        y: 0.1,
        width: 0.8,
        height: 0.8,
        direction: "radial",
        intensity: 1.0,
        density: 0.9,
        length: 35,
        angle: 0,
        color: "#333333",
        opacity: 0.9,
        blur: 0,
        selected: false,
        zIndex: 3,
        isGlobalPosition: false,
      },
      {
        panelId: 1,
        type: "explosion",
        x: 0.2,
        y: 0.2,
        width: 0.6,
        height: 0.6,
        direction: "radial",
        intensity: 0.8,
        density: 0.7,
        length: 25,
        angle: 45,
        color: "#ffaa44",
        opacity: 0.7,
        blur: 1,
        selected: false,
        zIndex: 2,
        isGlobalPosition: false,
      },
    ],
  },
};

// üè† Êó•Â∏∏Á≥ª„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„Éà
export const dailySceneTemplates: Record<string, EnhancedSceneTemplate> = {
  // üè´ Â≠¶Ê†°„ÉªÊïôÂÆ§Á≥ª
  school_classroom: {
    name: "üè´ Â≠¶Ê†°„ÉªÊïôÂÆ§",
    description: "Â≠¶Ê†°„Åß„ÅÆÊó•Â∏∏„Ç∑„Éº„É≥",
    category: 'daily',
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 120,
        y: 130,
        scale: 2.0,
        facing: "front",
        gaze: "right",
        pose: "sitting",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "right",
        eyeDirection: "right",
        isGlobalPosition: true,
        bodyDirection: "right",
        faceExpression: "normal",
        bodyPose: "sitting",
      },
      {
        panelId: 1,
        type: "friend",
        name: "Âèã‰∫∫",
        x: 430,
        y: 130,
        scale: 2.0,
        facing: "front",
        gaze: "left",
        pose: "sitting",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "smile",
        bodyPose: "sitting",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "ÂÆøÈ°å„ÇÑ„Å£„ÅüÔºü",
        x: 80,
        y: 70,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„ÇÑ„Å∞„ÅÑ...",
        x: 480,
        y: 65,
        scale: 1.0,
        width: 70,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    backgrounds: [
      {
        panelId: 1,
        type: "pattern",
        x: 0.0,
        y: 0.0,
        width: 1.0,
        height: 1.0,
        rotation: 0,
        zIndex: -1,
        opacity: 0.6,
        patternType: "grid",
        patternColor: "#cccccc",
        patternSize: 20,
        patternSpacing: 5,
      },
    ],
  },

  // üçï È£ü‰∫ã„Éª„Ç∞„É´„É°Á≥ª
  eating_meal: {
    name: "üçï È£ü‰∫ã„Éª„Ç∞„É´„É°",
    description: "ÁæéÂë≥„Åó„ÅÑÈ£ü‰∫ã„ÅÆ„Ç∑„Éº„É≥",
    category: 'daily',
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 280,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "down",
        pose: "sitting",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "smile",
        bodyPose: "sitting",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "ÁæéÂë≥„Åó„ÅÑ‚ô™",
        x: 150,
        y: 60,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
    effects: [
      {
        panelId: 1,
        type: "flash",
        x: 0.3,
        y: 0.3,
        width: 0.4,
        height: 0.4,
        direction: "radial",
        intensity: 0.6,
        density: 0.5,
        length: 15,
        angle: 0,
        color: "#ffdd88",
        opacity: 0.6,
        blur: 2,
        selected: false,
        zIndex: 1,
        isGlobalPosition: false,
      },
    ],
  },
};

// üéØ Áµ±ÂêàÈñ¢Êï∞Áæ§
export const getAllSceneTemplates = (): Record<string, EnhancedSceneTemplate> => {
  return {
    ...emotionSceneTemplates,
    ...actionSceneTemplates,
    ...dailySceneTemplates,
  };
};

export const getTemplatesByCategory = (category: 'emotion' | 'action' | 'daily'): Record<string, EnhancedSceneTemplate> => {
  const allTemplates = getAllSceneTemplates();
  const filtered: Record<string, EnhancedSceneTemplate> = {};
  
  Object.entries(allTemplates).forEach(([key, template]) => {
    if (template.category === category) {
      filtered[key] = template;
    }
  });
  
  return filtered;
};

// üöÄ Áµ±Âêà„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®Èñ¢Êï∞
export const applyEnhancedSceneTemplate = (
  templateKey: string,
  panels: any[],
  existingCharacters: any[],
  existingSpeechBubbles: any[],
  existingBackgrounds: any[],
  existingEffects: any[],
  existingTones: any[],
  selectedPanel?: any
): {
  characters: any[];
  speechBubbles: any[];
  backgrounds: any[];
  effects: any[];
  tones: any[];
} => {
  const template = getAllSceneTemplates()[templateKey];
  if (!template || panels.length === 0) {
    return {
      characters: existingCharacters,
      speechBubbles: existingSpeechBubbles,
      backgrounds: existingBackgrounds,
      effects: existingEffects,
      tones: existingTones,
    };
  }

  const targetPanel = selectedPanel || panels[0];
  const panelOffsetX = targetPanel.x;
  const panelOffsetY = targetPanel.y;

  console.log(`üé≠ Áµ±Âêà„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®: ${template.name} ‚Üí „Éë„Éç„É´${targetPanel.id}`);

  // „Ç≠„É£„É©„ÇØ„Çø„ÉºÁîüÊàê
  const newCharacters = template.characters.map((char) => ({
    ...char,
    id: `char_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
    x: char.x + panelOffsetX,
    y: char.y + panelOffsetY,
  }));

  // Âêπ„ÅçÂá∫„ÅóÁîüÊàê
  const newSpeechBubbles = template.speechBubbles.map((bubble) => ({
    ...bubble,
    id: `bubble_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
    x: bubble.x + panelOffsetX,
    y: bubble.y + panelOffsetY,
  }));

  // ËÉåÊôØÁîüÊàê
  const newBackgrounds = (template.backgrounds || []).map((bg) => ({
    ...bg,
    id: `bg_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
  }));

  // ÂäπÊûúÁ∑öÁîüÊàê
  const newEffects = (template.effects || []).map((effect) => ({
    ...effect,
    id: `effect_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
  }));

  // „Éà„Éº„É≥ÁîüÊàê
  const newTones = (template.tones || []).map((tone) => ({
    ...tone,
    id: `tone_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
  }));

  console.log(`‚úÖ Áµ±ÂêàË¶ÅÁ¥†ËøΩÂä†: „Ç≠„É£„É©${newCharacters.length}ÂÄã„ÄÅÂêπ„ÅçÂá∫„Åó${newSpeechBubbles.length}ÂÄã„ÄÅËÉåÊôØ${newBackgrounds.length}ÂÄã„ÄÅÂäπÊûúÁ∑ö${newEffects.length}ÂÄã„ÄÅ„Éà„Éº„É≥${newTones.length}ÂÄã`);

  return {
    characters: [...existingCharacters, ...newCharacters],
    speechBubbles: [...existingSpeechBubbles, ...newSpeechBubbles],
    backgrounds: [...existingBackgrounds, ...newBackgrounds],
    effects: [...existingEffects, ...newEffects],
    tones: [...existingTones, ...newTones],
  };
};

// Êó¢Â≠ò„ÅÆ„Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
export interface SceneTemplate {
  characters: Omit<Character, "id">[];
  speechBubbles: Omit<SpeechBubble, "id">[];
}

export const sceneTemplates: Record<string, SceneTemplate> = {
  daily: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 120,
        y: 130,
        scale: 2.0,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "normal",
        bodyPose: "standing",
      },
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 430,
        y: 130,
        scale: 2.0,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "normal",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„Åä„ÅØ„Çà„ÅÜÔºÅ",
        x: 80,
        y: 70,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„Åä„ÅØ„Çà„ÅÜ",
        x: 480,
        y: 65,
        scale: 1.0,
        width: 70,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  dialogue: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 100,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "right",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "right",
        eyeDirection: "right",
        isGlobalPosition: true,
        bodyDirection: "right",
        faceExpression: "normal",
        bodyPose: "standing",
      },
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 480,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "normal",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "‰Ωï„ÅãË©±„Åù„ÅÜ„Åã",
        x: 60,
        y: 60,
        scale: 1.0,
        width: 90,
        height: 70,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„Åù„ÅÜ„Å≠",
        x: 520,
        y: 55,
        scale: 1.0,
        width: 60,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  action: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 300,
        y: 140,
        scale: 2.5,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "fullBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "normal",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "„ÅÑ„Åè„ÅûÔºÅ",
        x: 150,
        y: 60,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  emotional: {
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 250,
        y: 120,
        scale: 2.3,
        facing: "front",
        gaze: "down",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "front",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "sad",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÂøÉ„ÅÆÂ£∞",
        text: "„Å©„ÅÜ„Åó„Çà„ÅÜ...",
        x: 380,
        y: 60,
        scale: 1.0,
        width: 90,
        height: 70,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  comedy: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 140,
        y: 130,
        scale: 2.2,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "front",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "surprised",
        bodyPose: "standing",
      },
      {
        panelId: 1,
        type: "friend",
        name: "Âèã‰∫∫",
        x: 410,
        y: 130,
        scale: 2.2,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "left",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "left",
        faceExpression: "smile",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "„Å™„Çì„Å¶„Åì„Å£„ÅüÔºÅ",
        x: 80,
        y: 60,
        scale: 1.0,
        width: 100,
        height: 80,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„Åæ„ÅÇ„Åæ„ÅÇ",
        x: 460,
        y: 65,
        scale: 1.0,
        width: 70,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  romance: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 150,
        y: 120,
        scale: 2.0,
        facing: "front",
        gaze: "right",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "rightFront",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "rightFront",
        faceExpression: "embarrassed",
        bodyPose: "standing",
      },
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 400,
        y: 120,
        scale: 2.0,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "leftFront",
        eyeDirection: "down",
        isGlobalPosition: true,
        bodyDirection: "leftFront",
        faceExpression: "embarrassed",
        bodyPose: "standing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Â∞èÂ£∞",
        text: "„ÅÇ„ÅÆ...",
        x: 100,
        y: 70,
        scale: 1.0,
        width: 60,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÂøÉ„ÅÆÂ£∞",
        text: "„Éâ„Ç≠„Éâ„Ç≠...",
        x: 450,
        y: 60,
        scale: 1.0,
        width: 70,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  tension: {
    characters: [
      {
        panelId: 1,
        type: "hero",
        name: "‰∏ª‰∫∫ÂÖ¨",
        x: 200,
        y: 130,
        scale: 2.0,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "back",
        eyeDirection: "front",
        isGlobalPosition: true,
        bodyDirection: "back",
        faceExpression: "worried",
        bodyPose: "standing",
      },
      {
        panelId: 1,
        type: "rival",
        name: "„É©„Ç§„Éê„É´",
        x: 380,
        y: 120,
        scale: 2.2,
        facing: "front",
        gaze: "left",
        pose: "standing",
        expression: "neutral",
        viewType: "halfBody",
        faceAngle: "leftBack",
        eyeDirection: "left",
        isGlobalPosition: true,
        bodyDirection: "leftBack",
        faceExpression: "angry",
        bodyPose: "arms_crossed",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "ÂøÉ„ÅÆÂ£∞",
        text: "Ê∞óÈÖç„Åå...",
        x: 120,
        y: 60,
        scale: 1.0,
        width: 80,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
      {
        panelId: 1,
        type: "ÊôÆÈÄö",
        text: "„Éï„ÉÉ...",
        x: 450,
        y: 70,
        scale: 1.0,
        width: 60,
        height: 50,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
  surprise: {
    characters: [
      {
        panelId: 1,
        type: "heroine",
        name: "„Éí„É≠„Ç§„É≥",
        x: 280,
        y: 120,
        scale: 2.5,
        facing: "front",
        gaze: "center",
        pose: "standing",
        expression: "neutral",
        viewType: "face",
        faceAngle: "front",
        eyeDirection: "up",
        isGlobalPosition: true,
        bodyDirection: "front",
        faceExpression: "surprised",
        bodyPose: "pointing",
      },
    ],
    speechBubbles: [
      {
        panelId: 1,
        type: "Âè´„Å≥",
        text: "„Åà„Å£ÔºÅÔºü",
        x: 150,
        y: 60,
        scale: 1.0,
        width: 70,
        height: 60,
        vertical: true,
        isGlobalPosition: true,
      },
    ],
  },
};

// Êó¢Â≠ò„ÅÆapplySceneTemplateÈñ¢Êï∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
export const applySceneTemplate = (
  sceneType: string,
  panels: any[],
  existingCharacters: Character[],
  existingSpeechBubbles: SpeechBubble[],
  selectedPanel?: any
): { characters: Character[], speechBubbles: SpeechBubble[] } => {
  const template = sceneTemplates[sceneType];
  if (!template || panels.length === 0) {
    return { characters: existingCharacters, speechBubbles: existingSpeechBubbles };
  }

  const targetPanel = selectedPanel || panels[0];
  const panelOffsetX = targetPanel.x;
  const panelOffsetY = targetPanel.y;

  console.log(`üé≠ „Ç∑„Éº„É≥„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ©Áî®: ${sceneType} ‚Üí „Éë„Éç„É´${targetPanel.id}`);

  const newCharacters = template.characters.map((char) => ({
    ...char,
    id: `char_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
    x: char.x + panelOffsetX,
    y: char.y + panelOffsetY,
  }));

  const newSpeechBubbles = template.speechBubbles.map((bubble) => ({
    ...bubble,
    id: `bubble_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
    panelId: targetPanel.id,
    x: bubble.x + panelOffsetX,
    y: bubble.y + panelOffsetY,
  }));

  console.log(`‚úÖ Êñ∞Ë¶èË¶ÅÁ¥†ËøΩÂä†: „Ç≠„É£„É©„ÇØ„Çø„Éº${newCharacters.length}ÂÄã„ÄÅÂêπ„ÅçÂá∫„Åó${newSpeechBubbles.length}ÂÄã`);

  return {
    characters: [...existingCharacters, ...newCharacters],
    speechBubbles: [...existingSpeechBubbles, ...newSpeechBubbles],
  };
};